CREATE OR REPLACE FUNCTION controllaticket() RETURNS trigger AS $controllaticket$
begin
--controlla che se assegnato è null, lo stato dev'essere nuovo
if (new.assegnato is null AND new.status <> 'nuovo')
then
raise exception 'A new ticket must have an ID associated';
end if;
--controlla che se se datachiusura è null,lo stato non deve essere risolto
if (new.datachiusura is null AND new.status ='risolto')
then
raise exception 'A closed ticket must have a closed date';
end if;
return new;
end;
$controllaticket$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION controllanotautente() RETURNS trigger AS $controllanotautente$
begin
--controlla che non venga inviato una nota a se stessi
if (new.id_creatore=new.id_destinatario)
then
raise exception 'No auto message';
end if;
return new;
end;
$controllanotautente$ LANGUAGE plpgsql;


CREATE TRIGGER controllaticket BEFORE INSERT OR UPDATE ON ticket
FOR EACH ROW EXECUTE PROCEDURE controllaticket();

CREATE TRIGGER controllanotautente BEFORE INSERT OR UPDATE ON notautente
FOR EACH ROW EXECUTE PROCEDURE controllanotautente();
